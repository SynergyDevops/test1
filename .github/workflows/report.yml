# This workflow runs lint, build and test of the mono repo

name: Quality Gate

on:
  pull_request:
    branches: [main]

  workflow_dispatch:

jobs:
  lint:
    name: Lint ğŸ“
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        uses: pnpm/action-setup@v2.2.4
        with:
          version: 7.11.0
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Nx Affected ğŸ‹
        uses: nrwl/nx-set-shas@v3.0.2
      - name: Lint ğŸ“
        run: |
          pnpm exec nx affected:lint --configuration=ci --parallel=3
          pnpm lint-non-code-files

  build_apps:
    name: Build apps ğŸ—ï¸
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        uses: pnpm/action-setup@v2.2.4
        with:
          version: 7.11.0
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Build ğŸ—ï¸
        run: |
          pnpm exec nx run-many \
            --target=build \
            --projects=$(pnpm exec nx affected:apps --all --plain | sed -r 's/[ ]+/,/g') \
            --parallel=3

  build_libs:
    name: Build libs ğŸ—ï¸
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        uses: pnpm/action-setup@v2.2.4
        with:
          version: 7.11.0
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Build ğŸ—ï¸
        run: |
          pnpm exec nx run-many \
            --target=build \
            --projects=$(pnpm exec nx affected:libs --all --plain | sed -r 's/[ ]+/,/g') \
            --parallel=3

  test:
    name: Test âœ…
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        uses: pnpm/action-setup@v2.2.4
        with:
          version: 7.11.0
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Test âœ…
        run: |
          pnpm exec nx run-many --target=test --parallel=3

  storybook:
    name: Storybook ğŸ“–
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        uses: pnpm/action-setup@v2.2.4
        with:
          version: 7.11.0
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Storybook Build ğŸ“–
        run: |
          pnpm exec nx run storybook:storybook:build
